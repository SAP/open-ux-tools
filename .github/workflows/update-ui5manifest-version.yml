name: Update @ui5/manifest Version

# This workflow complements Renovate PRs for @ui5/manifest by adding:
# - Test assertion updates (hardcoded values that can't be auto-updated)
# - Manifest fixture updates
# - Changeset creation

on:
    # Trigger when Renovate creates, rebases or reopens a PR for @ui5/manifest
    pull_request:
        types: [opened, synchronize, reopened]
        branches: [main]

jobs:
    update-manifest-fixtures:
        name: Update @ui5/manifest Fixtures
        runs-on: ubuntu-latest
        # Only run for Renovate PRs that update @ui5/manifest
        if: |
            github.actor == 'renovate[bot]' &&
            contains(github.event.pull_request.title, '@ui5/manifest')

        steps:
            - name: Checkout PR branch
              uses: actions/checkout@v6
              with:
                  ref: ${{ github.head_ref }}
                  fetch-depth: 0
                  token: ${{ secrets.ACCESS_PAT }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4.2.0
              with:
                  run_install: false

            - name: Use Node.js 22.x
              uses: actions/setup-node@v6
              with:
                  node-version: 22.x
                  cache: 'pnpm'

            - name: Install pnpm modules
              run: pnpm install --frozen-lockfile

            - name: Run update script
              run: node scripts/update-ui5manifest-version.js

            - name: Check for changes
              id: check-changes
              run: |
                  if [[ -n $(git status --porcelain) ]]; then
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                  else
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Commit changes to Renovate PR
              if: steps.check-changes.outputs.has_changes == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  # Stage only expected files to avoid committing unrelated changes
                  git add \
                    'packages/ui5-application-writer/test/__snapshots__/' \
                    'packages/fiori-app-sub-generator/test/' \
                    'packages/ui5-info/src/ui5-version-fallback.ts' \
                    '.changeset/*.md' \
                    'pnpm-lock.yaml' \
                    2>/dev/null || true
                  git commit -m "chore: update manifest version test fixtures, ui5 version fallbacks & changeset" || echo "No changes to commit"
                  git push

    notify:
        name: Send Notification
        needs: update-manifest-fixtures
        if: always() && needs.update-manifest-fixtures.result != 'skipped'
        runs-on: ubuntu-latest
        steps:
            - name: Send Slack notification (success)
              if: needs.update-manifest-fixtures.result == 'success' && env.SLACK_WEBHOOK_URL != ''
              uses: slackapi/slack-github-action@v2
              with:
                  payload: |
                      {"text": ":package: @ui5/manifest updated in PR #${{ github.event.pull_request.number }}\n\nPlease review: ${{ github.event.pull_request.html_url }}"}
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

            - name: Send Slack notification (failure)
              if: needs.update-manifest-fixtures.result == 'failure' && env.SLACK_WEBHOOK_URL != ''
              uses: slackapi/slack-github-action@v2
              with:
                  payload: |
                      {"text": ":warning: @ui5/manifest update workflow failed for PR #${{ github.event.pull_request.number }}\n\nPlease check: ${{ github.event.pull_request.html_url }}"}
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

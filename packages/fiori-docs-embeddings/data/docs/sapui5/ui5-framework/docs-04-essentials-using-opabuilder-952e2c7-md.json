{
  "id": "sapui5-docs-04-essentials-using-opabuilder-952e2c7-md",
  "title": "Using `OpaBuilder`",
  "category": "ui5-framework",
  "path": "docs/04_Essentials/using-opabuilder-952e2c7.md",
  "lastModified": "2025-09-01T18:17:10.553Z",
  "tags": [
    "ui5-framework",
    "md",
    "Using",
    "`OpaBuilder`"
  ],
  "headers": [
    "Using `OpaBuilder`",
    "Simulating a `press` Event",
    "Complex Interaction with Child Elements",
    "Custom Functions and Chaining",
    "Additional Features",
    "Generated Error Message",
    "Success Message and Description",
    "Aggregation Matcher",
    "Conditional Actions",
    "Commonly Used Matchers and Actions"
  ],
  "content": "<!-- loio952e2c7458e14d6581cdfc510fbb272a -->\n\n# Using `OpaBuilder`\n\nWrite tests by leveraging the builder pattern to create OPA5 descriptors.\n\n`sap.ui.test.OpaBuilder` is available as of version 1.74.\n\nThe main benefit for developers is having a function-driven API at hand, which supports and promotes a clean test definition and execution.\n\nIn [Simulating User Interactions on Controls](simulating-user-interactions-on-controls-8615a0b.md), we provided some examples on how to interact with controls. Let's have a look at some by implementing them using `OpaBuilder`.\n\n\n\n<a name=\"loio952e2c7458e14d6581cdfc510fbb272a__section_zys_cq4_xjb\"/>\n\n## Simulating a `press` Event\n\nThe `waitFor` options for this straightforward example are as follows:\n\n```js\nreturn oOpa.waitFor({\n    id: \"myButton\",\n    actions: new Press()\n});\n```\n\nWhen you use `OpaBuilder`, it looks like this:\n\n```js\nreturn oOpa.waitFor(\n    new OpaBuilder()\n        .hasId(\"myButton\")\n        .doPress()\n        .build()\n);\n```\n\nThe result of the `OpaBuilder.build` method is the configuration object for the `Opa5.waitFor` method. Because it's commonly used just as such, `OpaBuilder` comes with a convenient `OpaBuilder.execute()` method. The required `Opa5` instance can be provided as a parameter to the `execute` function, or you can use the `constructor` or `create` method. Taking this into account, the previous example can also be written like this:\n\n```js\nreturn OpaBuilder.create(oOpa)\n    .hasId(\"myButton\")\n    .doPress()\n    .execute();\n```\n\nFor more information, see [`OpaBuilder.build`](https://ui5.sap.com/#/api/sap.ui.test.OpaBuilder/methods/build), [`OpaBuilder.execute`](https://ui5.sap.com/#/api/sap.ui.test.OpaBuilder/methods/execute), and [`OpaBuilder.create`](https://ui5.sap.com/#/api/sap.ui.test.OpaBuilder/methods/sap.ui.test.OpaBuilder.create).\n\n\n\n<a name=\"loio952e2c7458e14d6581cdfc510fbb272a__section_lvr_tt4_xjb\"/>\n\n## Complex Interaction with Child Elements\n\nLet's assume we want to show the suggestion list with a filter for \"Jo\". The `waitFor` definition could look like this:\n\n```js\noOpa.waitFor({\n    id: \"formInput\",\n    actions: [\n        new EnterText({\n            text: \"Jo\",\n            keepFocus: true\n        }),\n        function (oInput) {\n            this.waitFor({\n                controlType: \"sap.m.StandardListItem\",\n                matchers: [\n                    new Ancestor(oInput),\n                    new Properties({ title: \"John\" })\n                ],\n                actions: new Press()\n            });\n        }\n    ]\n});\n```\n\n`OpaBuilder` comes with convenient functions to operate on aggregations and child elements: `OpaBuilder.doOnAggregation` and `OpaBuilder.doOnChildren`.\n\nWhile `doOnAggregation` requires the aggregation name of the defined control and only operates on those SAPUI5 aggregation items, `doOnChildren` addresses any control that is a child within the control hierarchy. Internally, the `sap.ui.test.Matchers.Ancestor` matcher is used as well, but the definition is simplified:\n\n```js\nOpaBuilder.create(oOpa)\n    .hasId(\"formInput\")\n    .doEnterText(\"Jo\", false, true),\n    .doOnChildren(\n        OpaBuilder.create(oOpa)\n            .hasType(\"sap.m.StandardListItem\")\n            .hasProperties({ title: \"John\" })\n            .doPress()\n    )\n    .execute();\n```\n\nFor more information, see [`OpaBuilder.doOnAggregation`](https://ui5.sap.com/#/api/sap.ui.test.OpaBuilder/methods/doOnAggregation) and [`OpaBuilder.doOnChildren`](https://ui5.sap.com/#/api/sap.ui.test.OpaBuilder/methods/doOnChildren).\n\n\n\n<a name=\"loio952e2c7458e14d6581cdfc510fbb272a__section_nyd_yv4_xjb\"/>\n\n## Custom Functions and Chaining\n\nLet's have a look at an example including a custom matcher and an action:\n\n```js\nWhen.waitFor({\n    id: \"entryList\",\n    matchers: [\n        new Properties({ mode: \"MultiSelect\" }),\n        function (oList) {\n            return oList.getItems().length > 0;\n        }\n    ],\n    actions: function (oList) {\n        for (var i = 0; i < oList.getItems().length; ++i) {\n            oList.setSelectedItem(oList.getItems()[i], true);\n        }\n    },\n    errorMessage: \"Could not select all items\"\n});\n```\n\n> ### Note:  \n> This example showcases the usage of a custom action. The best practice that we recommend is to use only `Press` and `EnterText` actions when simulating user interactions.\n\nBesides user-defined functions, the example also contains two matchers. As the parameter of the `has` method accepts the same types as the `matchers` property, this part could directly be rewritten as:\n\n```js\n...\n    .has([\n        new Properties({ mode: \"MultiSelect\" }),\n        function (oList) {\n            return oList.getItems().length > 0;\n        }\n    ])\n...\n```\n\nHowever, by leveraging the builder pattern, the `.has` methods can easily be chained. The resulting `matchers` options are an array consisting of all defined single matchers in the order of definition. This is similar to the `.do` method and the `actions` property.\n\n```js\nOpaBuilder.create(When)\n    .hasId(\"entryList\")\n    .hasProperties({ mode: \"MultiSelect\" })\n    .has(function (oList) {\n        return oList.getItems().length > 0;\n    })\n    .do(function (oList) {\n        for (var i = 0; i < oList.getItems().length; ++i) {\n            oList.setSelectedItem(oList.getItems()[i], true);\n        }\n    })\n    .error(\"Could not select all items\")\n    .execute();\n```\n\nWhile `matchers` and `actions` can be an array of functions, the more seldom used `check` and `success` properties must be a single function. Nevertheless, due to the builder pattern, those functions can be chained as well:\n\n```js\nOpaBuilder.create()\n    .check(fnCheck1)\n    .check(fnCheck2)\n    .check(fnCheck3)\n    .success(fnAssert1)\n    .success(fnAssert2)\n    .build();\n```\n\n`OpaBuilder` chains those functions, which results in the following `waitFor` options:\n\n```js\n{\n    check: function (vInput) {\n        return function(vInput) {\n            return fnCheck1(vInput) && fnCheck2(vInput);\n       ) && fnCheck3(vInput);\n    },\n    success: function (vInput) {\n        fnAssert1(vInput);\n        fnAssert2(vInput);\n    }\n}\n```\n\n\n\n<a name=\"loio952e2c7458e14d6581cdfc510fbb272a__section_dlk_2z4_xjb\"/>\n\n## Additional Features\n\nWhile `OpaBuilder` itself cannot extend the features provided by `Opa5.waitFor`, it comes with some convenient methods to support test definition. Besides the already mentioned child element support, method chaining, and most commonly used matchers and actions as predefined functions, there are some less obvious features.\n\n\n\n### Generated Error Message\n\nIf no error message is explicitly defined, `OpaBuilder` generates an error message when calling `build()`. The message consists of the `controlType` and `id` properties as well as the number of any additional matchers. A generated `errorMessage` can look like this:\n\n```js\nsap.m.Button#myButton with 1 additional matcher(s) not found\n```\n\n\n\n### Success Message and Description\n\nWhen defining an OPA5 test without an assertion, there's no output on success. Most often, such an output is useful for longer journeys, so the `OpaBuilder.success` method also accepts a string argument. This generates a simple truthy assertion with the provided message as a success function:\n\n```js\nsuccess: function (vControls) {\n    Opa5.assert.ok(true, sSuccessMessage);\n}\n```\n\nThe `OpaBuilder.description` function can be used for even better logging. The provided message is set as `errorMessage` and assertion on success:\n\n```js\nOpaBuilder.description(\"Pressing 'Cancel' button\")\n\n// Output message...\n// ...in case of success\nPressing 'Cancel' button - OK\n\n// ...in case of failure\nPressing 'Cancel' button - FAILURE\n```\n\n\n\n### Aggregation Matcher\n\nA common use case of tests is finding and operating on a control with one or more aggregation items that fulfill certain conditions. While there are already some predefined matchers for aggregations in place, `OpaBuilder` comes with the generic `hasAggregation` and the most commonly used `hasAggregationProperties` methods. The `vMatchers` parameter of `hasAggregation` can be any matcher method \\(or matcher chain\\) that is executed against the items of the defined aggregation of the matching control.\n\n```js\nOpaBuilder.create(oOpa)\n    .hasType(\"sap.m.CustomListItem\")\n    .hasAggregation(\"content\", [\n        function(oContentItem) {\n            return oContentItem instanceof sap.m.Title;\n        },\n        { \n            properties: {\n                text: sMatchingTitle\n            }\n        }\n    ])\n    .press()\n    .description(\"Pressing list item with title: \" + sMatchingTitle)\n    .execute();\n```\n\n> ### Note:  \n> Defining two `hasAggregation` matchers can also match two different aggregation items. To ensure that one item fulfills all criteria, an all-criteria-matcher should be defined in the same `hasAggregation` call.\n\n\n\n### Conditional Actions\n\nWhen defining journeys, reusable functions in the page can speed up writing tests and their quality. Sometimes, the generic approach of those functions is not suitable. For example, a test fails if no control is found that matches the conditions. This could be a challenge if the control being tested is not guaranteed to exist.\n\n**Example**:\n\nLet's have an interaction that selects all items of a list that aren't selected yet.\n\n```js\nOpaBuilder.create(oOpa)\n    .hasType(\"sap.m.CustomListItem\")\n    .hasProperties({ selected: false })\n    .doPress()\n    .description(\"Selecting unselected items\")\n    .execute();\n```\n\nThis is fine as long as there is at least one unselected list item. When all items are already selected, the test fails, which is not what we want. Here, the `doConditional` function comes in handy:\n\n```js\nOpaBuilder.create(oOpa)\n    .hasType(\"sap.m.CustomListItem\")\n    .doConditional(\n        OpaBuilder.Matchers.properties({ selected: false }), \n        OpaBuilder.Actions.press()\n    )\n    .description(\"Selecting unselected items\")\n    .execute();\n```\n\n\n\n### Commonly Used Matchers and Actions\n\nAs already seen in the last example, `OpaBuilder` has two static members: `OpaBuilder.Matchers` and `OpaBuilder.Actions`. While there's no issue in using any matchers from `sap.ui.test.Matchers` in the `OpaBuilder` definition, the goal of the two members is to provide the most commonly used matchers and actions to be directly accessed when working with `OpaBuilder` without explicitly requiring them in the test class.\n\n`OpaBuilder.Actions` contains both `sap.ui.test.Actions.Press` and `sap.ui.test.Actions.EnterText`, while `OpaBuilder.Matchers` does **not** contain every predefined matcher in `sap.ui.test.Matchers`, but still provides some additional ones as described in the API.\n\n\n\n**Related Information**  \n\n\n[API Reference: `sap.ui.test.OpaBuilder`](https://ui5.sap.com/#/api/sap.ui.test.OpaBuilder)\n\n[API Reference: `sap.ui.test.OpaBuilder.Matchers`](https://ui5.sap.com/#/api/sap.ui.test.OpaBuilder.Matchers)\n\n[API Reference: `sap.ui.test.OpaBuilder.Actions`](https://ui5.sap.com/#/api/sap.ui.test.OpaBuilder.Actions)\n\n",
  "excerpt": "<!-- loio952e2c7458e14d6581cdfc510fbb272a --> Using OpaBuilder Write tests by leveraging the builder pattern to create OPA5 descriptors. sap.ui.test.OpaBuilder is available as of version 1.74. The mai...",
  "wordCount": 1253,
  "version": "1.0.0",
  "source": "sapui5",
  "sourceType": "github"
}
{
  "id": "fiori-samples-v2-apps-products-review-webapp-ext-controller-customfilter-controller-js",
  "title": "CustomFilter.controller",
  "category": "fiori-samples",
  "path": "V2/apps/products-review/webapp/ext/controller/CustomFilter.controller.js",
  "lastModified": "2025-09-29T10:06:39.363Z",
  "tags": [
    "fiori-samples",
    "js",
    "CustomFilter",
    "controller"
  ],
  "headers": [],
  "content": "# CustomFilter.controller.js\n\n```javascript\nsap.ui.define([\n\t\"sap/ui/model/Filter\",\n\t\"sap/m/Token\",\n\t\"sap/m/RatingIndicator\",\n\t\"sap/m/ComboBox\",\n\t\"sap/m/MultiInput\",\n\t\"sap/ui/comp/smartfilterbar/SmartFilterBar\"\n], function(Filter, Token, RatingIndicator, ComboBox, MultiInput, SmartFilterBar) {\n\t\"use strict\";\n\n\treturn sap.ui.controller(\"nw.epm.refapps.st.prod.manage.ext.controller.CustomFilter\", {\n\n\t\tonInitSmartFilterBarExtension: function(oEvent) {\n\t\t\t// the custom field in the filter bar might have to be bound to a custom data model\n\t\t\t// if a value change in the field shall trigger a follow up action, this method is the place to define and bind an event handler to the field\n\n\t\t\tthis.fnAddTokensFromMultiInput = function() {\n\t\t\t\t//List of suppliers loaded to the tableSelectDialog\n\t\t\t\tvar oSupplier = this.byId(\"selectedSuppliers\").getItems();\n\t\t\t\tvar oSupplierKey;\n\n\t\t\t\tvar oFilterSuppliers = this.byId(\"listReportFilter\").getControlByKey(\"Supplier\").getTokens();\n\t\t\t\t// Remove all selections\n\t\t\t\tfor (var i = 0; i < oSupplier.length; i++) {\n\t\t\t\t\toSupplier[i].setSelected(false);\n\t\t\t\t}\n\n\t\t\t\tif (oFilterSuppliers.length > 0) {\n\t\t\t\t\t// Get the keys of the Suppliers in the input field\n\t\t\t\t\tfor (i = 0; i < oFilterSuppliers.length; i++) {\n\t\t\t\t\t\toSupplierKey = oFilterSuppliers[i].getProperty(\"key\");\n\t\t\t\t\t\t// Now check find and select the entries in the tableSelectDialog\n\t\t\t\t\t\tfor (var j = 0; j < oSupplier.length; j++) {\n\t\t\t\t\t\t\tif (oSupplierKey === oSupplier[j].getBindingContext().getProperty(\"Supplier\")) {\n\t\t\t\t\t\t\t\toSupplier[j].setSelected(true);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\tonBeforeRebindTableExtension: function(oEvent) {\n\t\t\t// usually the value of the custom field should have an effect on the selected data in the table. \n\t\t\t// So this is the place to add a binding parameter depending on the value in the custom field.\n\t\t\tvar oBindingParams = oEvent.getParameter(\"bindingParams\");\n\t\t\tvar oFilter, aFilter = [];\n\t\t\toBindingParams.parameters = oBindingParams.parameters || {};\n\t\t\tvar oSmartTable = oEvent.getSource();\n\t\t\tvar oSmartFilterBar = this.byId(oSmartTable.getSmartFilterId());\n\n\t\t\tif (oSmartFilterBar instanceof SmartFilterBar) {\n\t\t\t\t//Custom Supplier filter\n\t\t\t\tvar oCustomControl = oSmartFilterBar.getControlByKey(\"Supplier\");\n\t\t\t\tif (oCustomControl instanceof MultiInput) {\n\t\t\t\t\taFilter = this._getTokens(oCustomControl, \"Supplier\");\n\t\t\t\t\tif (aFilter.length > 0) {\n\t\t\t\t\t\toBindingParams.filters.push.apply(oBindingParams.filters, aFilter);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t//Custom rating filter\n\t\t\t\toCustomControl = oSmartFilterBar.getControlByKey(\"to_CollaborativeReview/AverageRatingValue\");\n\t\t\t\tif (oCustomControl instanceof RatingIndicator) {\n\t\t\t\t\toFilter = this._getRatingFilter(oCustomControl);\n\t\t\t\t\tif (oFilter) {\n\t\t\t\t\t\toBindingParams.filters.push(oFilter);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\tonCustomSupplierDialogOpen: function() {\n\t\t\tif (!this._oSupplierDialog) {\n\t\t\t\tthis._oSupplierDialog = sap.ui.xmlfragment(this.getView().getId(),\n\t\t\t\t\t\"nw.epm.refapps.st.prod.manage.ext.fragment.CustomSupplierFilterSelectDialog\", this);\n\t\t\t}\n\t\t\tthis.getView().addDependent(this._oSupplierDialog);\n\t\t\tthis._oSupplierDialog.open();\n\t\t\tthis.byId(\"selectedSuppliers\").getBinding(\"items\").attachDataReceived(this.fnAddTokensFromMultiInput, this);\n\t\t\t//Force rebinding to ensure that if tokens are removed from input directly, they will not appear as selected in the\n\t\t\t//tableSelectDialog\n\t\t\tthis.byId(\"selectedSuppliers\").getBinding(\"items\").refresh();\n\n\t\t},\n\n\t\tonHandleCustomSupplierDialogSearch: function(oEvent) {\n\t\t\tthis.byId(\"selectedSuppliers\").getBinding(\"items\").detachDataReceived(this.fnAddTokensFromMultiInput, this);\n\t\t\tvar sValue = oEvent.getParameter(\"value\");\n\t\t\tvar oFilter = new Filter(\"CompanyName\", sap.ui.model.FilterOperator.Contains, sValue);\n\t\t\toEvent.getSource().getBinding(\"items\").filter([oFilter]);\n\t\t},\n\n\t\tonHandleCustomSupplierTableSelectDialogClose: function(oEvent) {\n\t\t\t// Don't execute event when dataRecevied as this is for new loading of suppliers only\n\t\t\tthis.byId(\"selectedSuppliers\").getBinding(\"items\").detachDataReceived(this.fnAddTokensFromMultiInput, this);\n\t\t\tvar aSelectedContext = oEvent.getParameter(\"selectedContexts\");\n\t\t\tif (aSelectedContext) {\n\t\t\t\tvar oMultiInput = this.getView().byId(\"Supplier-multiinput\");\n\t\t\t\tvar aTokens = [];\n\t\t\t\tif (aSelectedContext.length) {\n\t\t\t\t\tfor (var i = 0; i < aSelectedContext.length; i++) {\n\t\t\t\t\t\tvar oToken = new Token({\n\t\t\t\t\t\t\tkey: aSelectedContext[i].getObject().Supplier,\n\t\t\t\t\t\t\ttext: aSelectedContext[i].getObject().CompanyName\n\t\t\t\t\t\t});\n\t\t\t\t\t\taTokens.push(oToken);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// If no Suppliers have been selected, clear the input field because aTokens is empty\n\t\t\t\toMultiInput.setTokens(aTokens);\n\t\t\t\toMultiInput.fireChange();\n\t\t\t}\n\t\t\tthis.getView().updateBindings();\n\t\t},\n\n\t\tonHandleCustomSupplierTableSelectDialogCancel: function() {\n\n\t\t},\n\n\t\tgetCustomAppStateDataExtension: function(oCustomData) {\n\t\t\t//the content of the custom field shall be stored in the app state, so that it can be restored later again e.g. after a back navigation. \n\t\t\t//The developer has to ensure, that the content of the field is stored in the object that is returned by this method.\n\t\t\t//Example:\n\t\t\tif (oCustomData) {\n\t\t\t\tvar aKeyValues = [],\n\t\t\t\t\toSmartFilterBar = this.byId(\"listReportFilter\");\n\t\t\t\tif (oSmartFilterBar instanceof SmartFilterBar) {\n\t\t\t\t\tvar oCustomControl = oSmartFilterBar.getControlByKey(\"to_CollaborativeReview/AverageRatingValue\");\n\t\t\t\t\tif (oCustomControl instanceof RatingIndicator) {\n\t\t\t\t\t\toCustomData.AverageRatingValue = oCustomControl.getValue();\n\t\t\t\t\t}\n\t\t\t\t\toCustomControl = oSmartFilterBar.getControlByKey(\"Supplier\");\n\t\t\t\t\tif (oCustomControl instanceof MultiInput) {\n\t\t\t\t\t\t// If no supplier has been given, set empty to ensure that any values set by the last\n\t\t\t\t\t\t// variant are removed\n\t\t\t\t\t\taKeyValues = this._getKeyValuePairs(oCustomControl);\n\t\t\t\t\t\toCustomData.Supplier = aKeyValues;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\trestoreCustomAppStateDataExtension: function(oCustomData) {\n\t\t\t//in order to to restore the content of the custom field in the filter bar e.g. after a back navigation, \n\t\t\t//an object with the content is handed over to this method and the developer has to ensure, that the content of the custom field is set accordingly\n\t\t\t//also, empty properties have to be set\n\t\t\t//Example:\n\t\t\tvar oSmartFilterBar = this.byId(\"listReportFilter\"),\n\t\t\t\taTokens;\n\n\t\t\tif (oSmartFilterBar instanceof SmartFilterBar) {\n\t\t\t\tif (oCustomData.AverageRatingValue !== undefined) {\n\t\t\t\t\tvar oCustomControl = oSmartFilterBar.getControlByKey(\"to_CollaborativeReview/AverageRatingValue\");\n\t\t\t\t\tif (oCustomControl instanceof RatingIndicator) {\n\t\t\t\t\t\toCustomControl.setValue(oCustomData.AverageRatingValue);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (oCustomData.Supplier !== undefined) {\n\t\t\t\t\toCustomControl = oSmartFilterBar.getControlByKey(\"Supplier\");\n\t\t\t\t\tif (oCustomControl instanceof MultiInput) {\n\t\t\t\t\t\taTokens = this._createTokens(oCustomData.Supplier);\n\t\t\t\t\t\t// Set empty values too, to ensure that values are cleared if nothing is specified in the next variant\n\t\t\t\t\t\toCustomControl.setTokens(aTokens);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\t_getRatingFilter: function(oRatingSelect) {\n\t\t\tvar sRating = oRatingSelect.getValue(),\n\t\t\t\toFilter;\n\t\t\tif (sRating > 0) {\n\t\t\t\t//Apply lower and upper range for Average Rating filter\n\t\t\t\tvar sRatingLower = sRating - 0.5;\n\t\t\t\tvar sRatingUpper = sRating + 0.5;\n\t\t\t\toFilter = new Filter(\"to_CollaborativeReview/AverageRatingValue\", sap.ui.model.FilterOperator.BT,\n\t\t\t\t\tsRatingLower, sRatingUpper);\n\t\t\t}\n\t\t\treturn oFilter;\n\t\t},\n\n\t\t_getTokens: function(oControl, sName) {\n\t\t\tvar aToken, aFilters = [];\n\t\t\taToken = oControl.getTokens();\n\t\t\tif (aToken) {\n\t\t\t\tfor (var i = 0; i < aToken.length; i++) {\n\t\t\t\t\taFilters.push(new Filter(sName, \"EQ\", aToken[i].getProperty(\"key\")));\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn aFilters;\n\t\t},\n\n\t\t_getKeyValuePairs: function(oCustomControl) {\n\t\t\tvar aKeyValue = [],\n\t\t\t\toToken = oCustomControl.getTokens();\n\t\t\tif (oToken) {\n\t\t\t\tfor (var i = 0; i < oToken.length; i++) {\n\t\t\t\t\taKeyValue.push([oToken[i].getProperty(\"key\"), oToken[i].getProperty(\"text\")]);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn aKeyValue;\n\t\t},\n\n\t\t_createTokens: function(oCustomField) {\n\t\t\tvar aTokens = [];\n\t\t\tfor (var i = 0; i < oCustomField.length; i++) {\n\t\t\t\taTokens.push(new Token({\n\t\t\t\t\tkey: oCustomField[i][0],\n\t\t\t\t\ttext: oCustomField[i][1]\n\t\t\t\t}));\n\t\t\t}\n\t\t\treturn aTokens;\n\t\t},\n\n\t\t// If a user deletes a token on in the supplier multiinput field, set dirty state\n\t\tonTokenUpdate: function(oEvent) {\n\n\t\t\tthis.byId(\"listReportFilter\").fireFilterChange();\n\t\t}\n\n\t});\n});\n```",
  "excerpt": "CustomFilter.controller.js",
  "wordCount": 835,
  "version": "1.0.0",
  "source": "fiori-samples",
  "sourceType": "github"
}